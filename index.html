<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard CSV - Avícola</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <header class="bg-white shadow-md p-4 sticky top-0 z-50 w-full">
    <div class="container mx-auto flex justify-between items-center px-4">
      <h1 class="text-xl font-bold">Avícola Belo Vale</h1>
    </div>
  </header>

  <section id="graficos" class="container mx-auto px-4 py-6">
    <h2 class="text-lg font-semibold mb-4">Relatórios Gerados</h2>
    <div id="chartContainer" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"></div>
  </section>

  <script>
    const chartContainer = document.getElementById('chartContainer');

    window.addEventListener('DOMContentLoaded', () => {
      fetch('dados.csv')
        .then(response => response.text())
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => processarDados(results.data)
          });
        })
        .catch(error => {
          chartContainer.innerHTML = `<p class="text-red-600">Erro ao importar: ${error.message}</p>`;
        });
    });

    function processarDados(data) {
      chartContainer.innerHTML = "";
      const grouped = {};

      data.forEach(row => {
        const tipo = (row['Tipo'] || '').trim();
        const categoria = (row['Categoria'] || '').trim();
        const grafico = (row['Grafico'] || 'bar').toLowerCase().trim();

        if (!grouped[tipo]) {
          grouped[tipo] = { labels: [], datasets: {}, grafico };
        }

        grouped[tipo].labels.push(categoria);

        Object.keys(row).forEach(col => {
          if (!['Tipo', 'Categoria', 'Grafico'].includes(col)) {
            if (!grouped[tipo].datasets[col]) grouped[tipo].datasets[col] = [];
            grouped[tipo].datasets[col].push(parseFloat(row[col]) || 0);
          }
        });
      });

      Object.entries(grouped).forEach(([titulo, dados], index) => {
        const card = document.createElement('div');
        card.classList.add('bg-white', 'rounded-xl', 'shadow-md', 'p-4', 'aspect-square', 'flex', 'flex-col');
        const canvas = document.createElement('canvas');
        canvas.id = `chart${index}`;
        canvas.classList.add('w-full');
        canvas.style.height = '100%';
        canvas.style.width = '100%';
        card.appendChild(canvas);
        chartContainer.appendChild(card);

        const cores = [
          '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'
        ];

        new Chart(canvas.getContext('2d'), {
          type: dados.grafico,
          data: {
            labels: dados.labels,
            datasets: Object.entries(dados.datasets).map(([label, valores], i) => ({
              label,
              data: valores,
              borderColor: cores[i % cores.length],
              backgroundColor: cores[i % cores.length],
              borderWidth: 2,
              fill: false,
              tension: 0.3
            }))
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true
              },
              title: {
                display: true,
                text: titulo
              }
            },
            scales: ['pie', 'doughnut', 'radar'].includes(dados.grafico) ? {} : {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      });
    }
  </script>
</body>
</html>
